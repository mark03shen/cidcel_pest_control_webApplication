{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
</head>
<body>
  <div class="sidebar" id="sidebar">
    <button class="close-sidebar" onclick="toggleSidebar()">‚Üê</button>
    <a href="{% url 'analytics' %}">Analytics</a>
    <a href="{% url 'pest_activity' %}">Pest Activity</a>
    <a href="{% url 'sales' %}">sales</a>
    <a href="{% url 'reports' %}">Reports</a>
  </div>

  <div class="header">
    <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
    <div class="header-nav">
      <a href="{% url 'admin_home' %}">Home</a>
      <a href="{% url 'appointment' %}">Appointment</a>
      <a href="{% url 'customers' %}">Customers</a>
      <a href="{% url 'inventory' %}">Inventory</a>
    </div>
    <div class="notification-wrapper">
      <button onclick="toggleNotificationModal()" class="notification-button">
        üîî
        {% if notifications|length > 0 %}
        <span class="notification-badge">
          {{ notifications|length }}
        </span>
        {% endif %}
      </button>
    </div>

    <form action="{% url 'logout' %}" method="post" style="margin: 0;">
      {% csrf_token %}
      <button class="logout-btn">Logout</button>
    </form>
  </div>

  <!-- Admin Notification Modal -->
  <div id="notificationModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index:1000;">
    <div style="background:#fff; padding:20px; margin:5% auto; width:90%; max-width:700px; border-radius:8px; position:relative;">

      <h2 style="text-align:center;">Notifications</h2>

      <!-- üîò Filter Buttons -->
      <div style="text-align:center; margin-bottom:15px;">
        <button class="notif-tab active" onclick="showNotifTab('all')">All</button>
        <button class="notif-tab" onclick="showNotifTab('tech')">Technician</button>
        <button class="notif-tab" onclick="showNotifTab('cust')">Customer</button>
      </div>

      <!-- All Notifications -->
      <div id="notif-all" class="notif-section">
        <h3>All Notifications</h3>
        <hr>
        <ul style="list-style:none; padding:0; max-height:300px; overflow-y:auto;">
          {% for note in notifications %}
            <li onclick="showNotificationDetail({{ note.id }})" style="border-bottom: 1px solid #ccc; padding: 10px 0; cursor: pointer;">
              <strong>{{ note.technician.username }}</strong>: {{ note.message }}<br>
              {% if note.appointment %}
                <span><strong>Client Email:</strong> {{ note.appointment.email }}</span><br>
                <span><strong>Client Mobile:</strong> {{ note.appointment.mobile }}</span><br>
              {% endif %}
              <small>{{ note.timestamp|date:"M d, Y H:i" }}</small>
            </li>
          {% endfor %}
          {% for cnote in customer_notifications %}
            <li style="border-bottom: 1px solid #ccc; padding: 10px 0;">
              <strong>{{ cnote.client_name }}</strong> booked an appointment<br>
              <span><strong>Service:</strong> {{ cnote.appointment.service }}</span><br>
              <span><strong>Date:</strong> {{ cnote.appointment.date }}</span>  
              <span><strong>Time:</strong> {{ cnote.appointment.time }}</span><br>
              <span><strong>Email:</strong> {{ cnote.appointment.email }}</span><br>
              <span><strong>Mobile:</strong> {{ cnote.appointment.mobile }}</span><br>
              <small>{{ cnote.timestamp|date:"M d, Y H:i" }}</small>
            </li>
          {% endfor %}
        </ul>
      </div>

      <!-- Technician Notifications Only -->
      <div id="notif-tech" class="notif-section" style="display:none;">
        <h3>Technician Notifications</h3>
        <hr>
        <ul style="list-style:none; padding:0; max-height:300px; overflow-y:auto;">
          {% for note in notifications %}
            <li onclick="showNotificationDetail({{ note.id }})" style="border-bottom: 1px solid #ccc; padding: 10px 0; cursor: pointer;">
              <strong>{{ note.technician.username }}</strong>: {{ note.message }}<br>
              <small>{{ note.timestamp|date:"M d, Y H:i" }}</small>
            </li>
          {% empty %}
            <li>No technician notifications found.</li>
          {% endfor %}
        </ul>
      </div>

      <!-- Customer Notifications Only -->
      <div id="notif-cust" class="notif-section" style="display:none;">
        <h3>Customer Notifications</h3>
        <hr>
        <ul style="list-style:none; padding:0; max-height:300px; overflow-y:auto;">
          {% for cnote in customer_notifications %}
            <li style="border-bottom: 1px solid #ccc; padding: 10px 0;">
              <strong>{{ cnote.client_name }}</strong> booked an appointment<br>
              <span><strong>Service:</strong> {{ cnote.appointment.service }}</span><br>
              <small>{{ cnote.timestamp|date:"M d, Y H:i" }}</small>
            </li>
          {% empty %}
            <li>No customer notifications.</li>
          {% endfor %}
        </ul>
      </div>

      <button onclick="closeNotificationModal()" style="margin-top: 20px;">Close</button>
    </div>
  </div>


  <!-- Single Notification Detail Modal -->
  <div id="notificationDetailModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index:1000;">
    <div style="background:#fff; padding:20px; margin:10% auto; width:90%; max-width:600px; border-radius:8px; position:relative;">
      <h3>Notification Details</h3>
      <div id="notificationDetailContent"></div>
      <button onclick="closeNotificationDetail()" style="margin-top: 20px;">Close</button>
    </div>
  </div>

  <div class="main" id="mainContent">
    <div class="content-wrapper"> 

      <div class="card">
        
        <div class="card">
          <h1>Service Demand Forecast</h1>
          <p>Project service demand based on historical data</p>
          <canvas id="serviceDemandChart" height="150"></canvas>
        </div>
      </div>

      <!-- Completed Jobs Over Time -->
      <div class="card">
        
        <div class="card">
          <h1>Completed Jobs Over Time</h1>
          <p>Track completed jobs with daily, monthly, and yearly breakdowns.</p>

          <!-- Dropdown to switch view -->
          <label for="jobTimeFilter"><strong>View by:</strong></label>
          <select id="jobTimeFilter" onchange="updateJobsChart()">
            <option value="daily">Daily</option>
            <option value="monthly" selected>Monthly</option>
            <option value="yearly">Yearly</option>
          </select>

          <canvas id="jobsOverTimeChart" height="150"></canvas>
        </div>
      </div>

      <!-- Land Use Categories -->
      <div class="card">
        
        <div class="card">
          <h1>Land Use Categories</h1>
          <p>Distribution by land use categories (Total = 100%)</p>
          <canvas id="landUseChart" height="150"></canvas>
        </div>
      </div>

    </div>
  </div>

<script>
function toggleSidebar() {
  const sidebar = document.getElementById("sidebar");
  const main = document.getElementById("mainContent");
  sidebar.classList.toggle("hidden");
  main.classList.toggle("full");
}

//--- for admin notification modal
function toggleNotificationModal() {
  const modal = document.getElementById('notificationModal');
  modal.style.display = 'block';
}

function closeNotificationModal() {
  document.getElementById('notificationModal').style.display = 'none';
}

// Optional: Close modal when clicking outside of it
window.addEventListener('click', function(e) {
  const modal = document.getElementById('notificationModal');
  if (e.target === modal) {
    modal.style.display = 'none';
  }
});

//--- for  single notification modal
function showNotificationDetail(notifId) {
  fetch(`/get-notification-detail/?id=${notifId}`)
    .then(response => response.json())
    .then(data => {
      const content = `
        <p><strong>Technician:</strong> ${data.technician}</p>
        <p><strong>Message:</strong> ${data.message}</p>
        
        <hr>
        ${data.client_name ? `
          <p><strong>Client:</strong> ${data.client_name}</p>
          <p><strong>Service:</strong> ${data.service}</p>
          <p><strong>Date:</strong> ${data.date}</p>
          <p><strong>Time:</strong> ${data.time}</p>
          <p><strong>Email:</strong> ${data.email}</p>
          <p><strong>Mobile:</strong> ${data.mobile}</p>
        ` : '<p>No appointment linked.</p>'}
      `;
      document.getElementById('notificationDetailContent').innerHTML = content;
      document.getElementById('notificationDetailModal').style.display = 'block';
    });
}

function closeNotificationDetail() {
  document.getElementById('notificationDetailModal').style.display = 'none';
}


const services = [
  {% for service in service_demand %}
    "{{ service.service }}"{% if not forloop.last %},{% endif %}
  {% endfor %}
];

const totalJobs = [
  {% for service in service_demand %}
    {{ service.total }}{% if not forloop.last %},{% endif %}
  {% endfor %}
];

const revenue = [
  {% for service in service_demand %}
    {{ service.revenue|floatformat:2 }}{% if not forloop.last %},{% endif %}
  {% endfor %}
];

// Simple forecast (next month) by linear extrapolation
const futureRevenue = revenue.map((val, idx) => (val * 1.1).toFixed(2)); // +10% growth
const futureJobs = totalJobs.map(val => Math.round(val * 1.1)); // +10% growth

const ctx = document.getElementById('serviceDemandChart').getContext('2d');
new Chart(ctx, {
  type: 'line',
  data: {
    labels: services,
    datasets: [
      {
        label: 'Total Jobs',
        data: totalJobs,
        borderColor: 'rgba(75, 192, 192, 1)',
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        tension: 0.3
      },
      {
        label: 'Revenue (‚Ç±)',
        data: revenue,
        borderColor: 'rgba(255, 206, 86, 1)',
        backgroundColor: 'rgba(255, 206, 86, 0.2)',
        tension: 0.3,
        yAxisID: 'y1'
      },
      {
        label: 'Forecasted Revenue (‚Ç±)',
        data: futureRevenue,
        borderColor: 'rgba(255, 99, 132, 1)',
        backgroundColor: 'rgba(255, 99, 132, 0.2)',
        borderDash: [5,5],
        tension: 0.3,
        yAxisID: 'y1'
      },
      {
        label: 'Forecasted Jobs',
        data: futureJobs,
        borderColor: 'rgba(54, 162, 235, 1)',
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        borderDash: [5,5],
        tension: 0.3
      }
    ]
  },
  options: {
    responsive: true,
    interaction: {
      mode: 'index',
      intersect: false
    },
    stacked: false,
    plugins: {
      title: {
        display: true,
        text: 'Service Demand Forecast'
      }
    },
    scales: {
      y: {
        type: 'linear',
        display: true,
        position: 'left',
        title: {
          display: true,
          text: 'Total Jobs'
        }
      },
      y1: {
        type: 'linear',
        display: true,
        position: 'right',
        grid: {
          drawOnChartArea: false
        },
        title: {
          display: true,
          text: 'Revenue (‚Ç±)'
        }
      }
    }
  }
});

// ===== DATA FROM DJANGO (monthly summary) =====
const monthlyLabels = [
  {% for j in jobs_over_time %}
    "{{ j.month|date:'F' }} {{ j.year }}"{% if not forloop.last %},{% endif %}
  {% endfor %}
];

const monthlyJobs = [
  {% for j in jobs_over_time %}
    {{ j.total }}{% if not forloop.last %},{% endif %}
  {% endfor %}
];

// ===== Placeholder (you can extend with AJAX for real daily/yearly data later) =====
const dailyLabels = Array.from({ length: 30 }, (_, i) => `Day ${i+1}`);
const dailyJobs = dailyLabels.map(() => Math.floor(Math.random() * 10) + 1);

const yearlyLabels = ["2022", "2023", "2024", "2025"];
const yearlyJobs = yearlyLabels.map(() => Math.floor(Math.random() * 150) + 50);

let currentView = 'monthly';
let jobsChart = null;

function createJobsChart(labels, data, titleText) {
  const ctx = document.getElementById('jobsOverTimeChart').getContext('2d');
  if (jobsChart) jobsChart.destroy(); // remove old chart

  jobsChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Completed Jobs',
        data: data,
        backgroundColor: 'rgba(75, 192, 192, 1)',
        borderColor: 'rgba(89, 189, 189, 1)',
        borderWidth: 1,
        borderRadius: 6,
        barPercentage: 0.6
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: titleText,
          font: { size: 18 }
        },
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.parsed.y} jobs completed`;
            }
          }
        }
      },
      scales: {
        x: {
          title: {
            display: true,
            text: currentView.charAt(0).toUpperCase() + currentView.slice(1)
          }
        },
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Completed Jobs'
          }
        }
      }
    }
  });
}

function updateJobsChart() {
  const filter = document.getElementById('jobTimeFilter').value;
  currentView = filter;

  if (filter === 'daily') {
    createJobsChart(dailyLabels, dailyJobs, 'Daily Completed Jobs');
  } else if (filter === 'monthly') {
    createJobsChart(monthlyLabels, monthlyJobs, 'Monthly Completed Jobs');
  } else if (filter === 'yearly') {
    createJobsChart(yearlyLabels, yearlyJobs, 'Yearly Completed Jobs');
  }
}

// Initial chart load
updateJobsChart();

// ===== LAND USE DATA FROM DJANGO =====
const landLabels = [
  {% for land in land_categories %}
    "{{ land.land_category }}"{% if not forloop.last %},{% endif %}
  {% endfor %}
];

const landPercentages = [
  {% for land in land_categories %}
    {{ land.percentage }}{% if not forloop.last %},{% endif %}
  {% endfor %}
];

const landColors = [
  'rgba(71, 110, 174, 0.8)',
  'rgba(255, 205, 86, 0.8)',
  'rgba(75, 192, 192, 0.8)',
  'rgba(255, 99, 132, 0.8)',
  'rgba(153, 102, 255, 0.8)',
  'rgba(54, 162, 235, 0.8)',
  'rgba(255, 159, 64, 0.8)'
];

const ctxLand = document.getElementById('landUseChart').getContext('2d');

new Chart(ctxLand, {
  type: 'pie',
  data: {
    labels: landLabels,
    datasets: [{
      data: landPercentages,
      backgroundColor: landColors,
      borderColor: '#fff',
      borderWidth: 2
    }]
  },
  options: {
    responsive: true,
    plugins: {
      title: {
        display: true,
        text: 'Land Use Categories (100%)',
        font: { size: 18 }
      },
      legend: {
        position: 'bottom',
        labels: { boxWidth: 20 }
      },
      datalabels: {
        color: '#fff',
        font: { weight: 'bold' },
        formatter: (value, context) => `${value}%`,
      },
      tooltip: {
        callbacks: {
          label: function(context) {
            return `${context.label}: ${context.parsed}%`;
          }
        }
      }
    }
  },
  plugins: [ChartDataLabels]
});

function showNotifTab(tab) {
  // Hide all sections
  document.querySelectorAll('.notif-section').forEach(s => s.style.display = 'none');

  // Remove active state from all buttons
  document.querySelectorAll('.notif-tab').forEach(btn => btn.classList.remove('active'));

  // Show selected section
  if (tab === 'all') {
    document.getElementById('notif-all').style.display = 'block';
    document.querySelector(".notif-tab:nth-child(1)").classList.add('active');
  } 
  else if (tab === 'tech') {
    document.getElementById('notif-tech').style.display = 'block';
    document.querySelector(".notif-tab:nth-child(2)").classList.add('active');
  } 
  else if (tab === 'cust') {
    document.getElementById('notif-cust').style.display = 'block';
    document.querySelector(".notif-tab:nth-child(3)").classList.add('active');
  }
}

</script>
</body>
<style>
body { 
  margin: 0; 
  font-family: Arial, 
  sans-serif; 
}
/* Sticky Header */
.header {
  position: sticky;
  top: 0;
  z-index: 999;
  background: #010A28;
  color: white;
  padding: 10px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.menu-btn, .logout-btn {
  background: none; 
  border: none; 
  color: white; 
  font-size: 16px; 
  cursor: pointer;
}
.sidebar {
  width: 250px; 
  background: #010A28; 
  height: 100vh; 
  position: fixed;
  top: 0; 
  left: 0;
  padding-top: 60px; 
  transform: translateX(0); 
  transition: transform 0.3s ease;
}
.sidebar.hidden { 
  transform: translateX(-100%); 
}
.sidebar a {
  display: block; 
  padding: 15px 20px; 
  color: white; 
  text-decoration: none;
}
.sidebar a:hover { 
  background: #2c3e50;
}
@media (max-width: 768px) {
  .main {
    margin-left: 0;
  }
  .sidebar {
    position: fixed;
    height: 100%;
    z-index: 998;
  }
}

.close-sidebar {
  position: absolute; 
  top: 10px; 
  right: 10px; 
  background: none; 
  border: none; 
  color: white;
  font-size: 20px; 
  cursor: pointer;
}
.main {
  margin-left: 250px; 
  padding: 20px;
  transition: margin-left 0.3s ease;
}
.main.full { 
  margin-left: 0; 
}
.header-nav a {
  margin-left: 20px; 
  color: white; 
  text-decoration: none;
}

/* for MAIN content*/
/* Container that wraps the cards */
.content-wrapper {
  max-width: 1200px;
  margin: auto;
  padding: 20px;
}

/* Responsive margin control for sidebar toggle */
.main {
  margin-left: 250px;
  padding: 20px;
  transition: margin-left 0.3s ease;
}

.main.full {
  margin-left: 0;
}

/* Cards */
.card {
  background: #CBDCEB;
  border: 1px solid #464646ff;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 30px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.card :hover {
  transform: translateY(-4px);
  transition: 0.2s;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}

.card th {
  background: #476EAE;
}

.card img {
  max-width: 100%;
  height: auto;
  display: block;
  margin-top: 15px;
}

.card h1, .card h2 {
  margin-top: 0;
}

.card .note {
  font-size: 0.9em;
  color: #555;
  margin-top: 10px;
}

.card-group {
  background: #f9f9f9;
  border: 1px solid #ccc;
  border-radius: 12px;
  padding: 25px;
  margin-bottom: 30px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
}

.card-group .card {
  background: #fff;
  border: none;
  box-shadow: none;
  margin-bottom: 20px;
  padding: 0;
}

.card-group .card h1, 
.card-group .card h2 {
  margin-top: 0;
}


/* Mobile Optimization */
@media (max-width: 768px) {
  .main {
    margin-left: 0 !important;
  }

  .sidebar {
    transform: translateX(-100%);
    position: fixed;
    z-index: 998;
    height: 100vh;
  }

  .sidebar.hidden {
    transform: translateX(0);
  }

  .content-wrapper {
    padding: 15px;
  }
}


/*for table*/
table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  font-family: Arial, sans-serif;
  font-size: 16px;
}

th, td {
  border: 1px solid #999;
  padding: 10px;
  text-align: center;
}

thead {
  background-color: #f2f2f2;
}

tbody tr:hover {
  background-color: #f9f9f9;
}

/*this is for notification css*/
.notification-wrapper {
  position: relative;
}

.notification-button {
  position: relative;
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  font-size: 18px; /* optional, adjust icon size */
}

.notification-badge {
  position: absolute;
  top: -5px;
  right: -5px;
  background: red;
  color: white;
  border-radius: 50%;
  padding: 2px 6px;
  font-size: 12px;
  font-weight: bold;
}

/* Notification Tabs */
.notif-tab {
  padding: 10px 15px;
  margin: 5px;
  border: none;
  background: #eee;
  cursor: pointer;
  border-radius: 8px;
  font-weight: bold;
  color: #DDAA1E;
}

.notif-tab.active {
  background: #010A28;
  color: white;
}

</style>
</html>
